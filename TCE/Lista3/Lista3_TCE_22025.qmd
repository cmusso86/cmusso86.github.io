---
title: "Lista 3"
subtitle: "Algoritmo EM (Expectationâ€“Maximization)"
author: 
  Carolina Musso
  251103768
date: today
institute: "Mestrado AcadÃªmico em EstatÃ­stica - UnB"
lang: pt
format: 
  html:
    toc: true
    toc-location: left
    toc-depth: 2
    number-sections: true
    self-contained: true
    embed-resources: true
editor: source
execute:
  echo: true
  message: false
  warning: false
---

## ExercÃ­cio: DuraÃ§Ã£o do desemprego

Seja $T$ uma variÃ¡vel aleatÃ³ria exponencial com FDP:

$$
f(t;\theta) = \theta e^{(-\theta t)}
$$
e FDA:

$$
F(t;\theta) = 1 - e^{(-\theta t)}
$$

Em anÃ¡lise de sobrevivÃªncia, confiabilidade ou mesmo economia, um estudo para observar uma amostra aleatÃ³ria proveniente de uma populaÃ§Ã£o pode terminar na prÃ¡tica antes de ser possÃ­vel observar toda a amostra, ou seja, podemos ter observaÃ§Ãµes censuradas.

Considere uma amostra referente Ã  duraÃ§Ã£o do desemprego, $t$, em dias, de 30 indivÃ­duos. A duraÃ§Ã£o do desemprego Ã© o evento de interesse, ou seja, o tempo atÃ© o indÃ­viduo deixar a situaÃ§Ã£o de desemprego. No entando, alguns indivÃ­duos podem nÃ£o experimentar o evento de interesse (nÃ£o encontrarem emprego ao final do estudo ou podem ter por algum motivo saÃ­do do estudo), resultando em censura Ã  direita.

Considere que temos acesso Ã s observaÃ§Ãµes:
{ğ‘¥ğ‘–=(ğ‘¡ğ‘–,ğ›¿ğ‘–),ğ‘–=1,â€¦,ğ‘›},
$$\{x_i = (t_i, \delta_i), i = 1, ..., n\}$$
sendo

$\delta_i = 1$ se a observaÃ§Ã£o ğ‘¡ğ‘– nÃ£o Ã© censurada;
$\delta_i = 0$ se a observaÃ§Ã£o ğ‘¡ğ‘– Ã© censurada.

Considere o modelo exponencial com censura e obtenha a estimativa de $\theta$ pelo algoritmo EM baseada nos dados abaixo:

```{r}
time <- c(8,  5,  2,  4,  2,  3,  6,  1,  5,  5, 10,  8,  5,  2,  1, 12,  4,  2, 4,  2,  7,  1,  6,  3,  9,  8,  3,  2, 14,  4)
  
status <- c(1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1)  
```
Dicas:

- Note que:

$$
f(z \mid y_i; \theta_0) = \frac{f(z; \theta_0)}{1 - F(y_i; \theta_0)} = \frac{\theta_0 e^{-\theta_0 z}}{e^{-\theta_0 y_i}} = \theta_0 e^{-\theta_0 (z - y_i)}, \quad z > y_i;
$$

- Note que: 

$$\mathbb{E}_{\theta_0}[Z_i] = y_i + \frac{1}{\theta_0}$$

- A verossimilhanÃ§a da amostra amplicada (completa) $(y,z)$ Ã© dada por

$$
L_c(\theta; \mathbf{y}, \mathbf{z}) = \prod_{i=1}^{m} f(y_i; \theta) \prod_{i=m+1}^{n} f(z_i; \theta)
$$


- Note que a estimativa de MV baseada na log-verossimilhanÃ§a com dados censurados Ã©:

$$\hat{\theta} = \left( \frac{n}{m }\bar{y} \right)^{-1}$$

### SoluÃ§Ã£o

O primeiro passo para a execuÃ§Ã£o do algoritmo Ã© o cÃ¡lculo da EsperaÃ§a $E_{\theta_0}[l^c{(\theta;Z, y)}]$.


$$
\begin{align}
\ell_c(\theta; \mathbf{y}, \mathbf{z}) 
&= \log L_c(\theta; \mathbf{y}, \mathbf{z}) \\
&= \log \left( \prod_{i=1}^{m} \theta e^{-\theta y_i} \prod_{i=m+1}^{n} \theta e^{-\theta z_i} \right)\\
&= n \log(\theta) - \theta \left( \sum_{i=1}^{m} y_i + \sum_{i=m+1}^{n} z_i \right)
\end{align}

$$
Segundo o exemplo das notas de aula:
$$
\begin{align}
Q(\theta, \theta_0) 
&= \mathbb{E}_{\theta_0} \left[ \ell_c(\theta; \mathbf{y}, \mathbf{z}) \right] \\
&= n \log(\theta) - \theta \left( \sum_{i=1}^{m} y_i + \sum_{i=m+1}^{n} \mathbb{E}_{\theta_0}[Z_i] \right)
\end{align}
$$


$$
\text{Como } \mathbb{E}_{\theta_0}[Z_i] = z_i + \frac{1}{\theta_0}, \text{ entÃ£o:}
$$

$$
\begin{align}
Q(\theta, \theta_0) 
&= n \log(\theta) - \theta \left( \bar{y}m + \sum_{i=m+1}^{n} z_i + (n - m) \frac{1}{\theta_0} \right)
\end{align}
$$

Agora procedemos com a maximizaÃ§Ã£o. Para tal precisamos derivar a funÃ§Ã£o $Q(\theta, \theta_0)$ em relaÃ§Ã£o a $\theta$ e igualar a zero. Como $\theta_0$ Ã© uma dado, podemos tratÃ¡-la como uma constante.
$$
\begin{align}
\Rightarrow \quad
\hat{\theta} 
&= \frac{n}{m \bar{y} + \sum_{i=m+1}^{n} z_i + (n - m) \frac{1}{\theta_0}}
\end{align}
$$

Essa serÃ¡ usada como equaÃ§Ã£o de atualizaÃ§Ã£o do algoritmo EM.

```{r}
# Dados fornecidos
time <- c(8, 5, 2, 4, 2, 3, 6, 1, 5, 5, 10, 8, 5, 2, 1, 12, 4, 2, 4, 2, 7, 1, 6, 3, 9, 8, 3, 2, 14, 4)
status <- c(1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1)

# Separar observaÃ§Ãµes censuradas e nÃ£o censuradas
observado <- time[status == 1]
censurado <- time[status == 0]

m <- length(observado)   # nÃ£o censuradas
n <- length(time)       # total
ybar <- mean(observado)  # mÃ©dia das observaÃ§Ãµes nÃ£o censuradas
ti_cens <- censurado     # tempos censurados observados (limite inferior dos Z_i)

# InicializaÃ§Ã£o
theta <- numeric()
set.seed(425)
theta[1] <- rnorm(1, mean = ybar, sd = sd(observado))
cat("theta[1] =", theta[1], "\n")

# Loop EM
i <- 1
nonstop <- TRUE
tol <- 1e-5

while (nonstop) {
  numerador <- n
  denominador <- m * ybar + sum(ti_cens) + (n - m) * (1 / theta[i])
  theta[i + 1] <- numerador / denominador
  
  i <- i + 1
  cat("theta[", i, "] =", theta[i], "\n")
  
  # CritÃ©rio de parada
  nonstop <- abs(theta[i] - theta[i - 1]) > tol
}

# Estimativa final
cat("\nEstimativa final de theta:", theta[i], "\n")

```

Dada essa parametrizaÃ§Ã£o, o tempo mÃ©dio Ã© dado pelo inverso de teta portanto e  **`r round(1/theta[i],2)` dias**. 

